{"version":3,"file":"leaderboardController.js","sourceRoot":"","sources":["../../../src/controllers/leaderboardController.ts"],"names":[],"mappings":"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","sourcesContent":["import { NextFunction, Request, Response, Router} from \"express\";\nimport Helpers = require(\"../helperFunctions\");\nimport { CustomerModel } from \"../models/customerModel\";\nimport { NotificationModel } from \"../models/notificationModel\";\nimport { ProductModel } from \"../models/productModel\";\nimport { BaseRoute } from \"../routes/router\";\n\nlet leaderboard: any[] = [];\nlet Shoes: any;\nlet users: any;\nlet allUserShoes: any;\n\nexport class LeaderboardController extends BaseRoute {\n\n    public static create(router: Router) {\n        router.get(\"/user/:id/leaderboard\", (req: Request, res: Response, next: NextFunction) => {\n            new LeaderboardController().leaderboard(req, res, next);\n        });\n    }\n\n    public async leaderboard(req: Request, res: Response, next: NextFunction) {\n        const idString = \"id\";\n        const userId = parseInt(req.params[idString], 10);\n        if (await Helpers.isUser(userId)) {\n            await this.createBoard();\n            this.render(req, res, \"leaderboard\", {id: userId, title: \"Leaderboard\", leaderboard});\n        } else {\n            res.status(404)\n            .send({\n                message: \"No user with associated ID. Check the entered number.\",\n                status: res.status,\n            });        }\n    }\n\n    private async createBoard() {\n        leaderboard = [];\n        await this.setLocals();\n        for (const item in users) {\n            if (users.hasOwnProperty(item)) {\n                const ranking = users[item];\n                // console.log(ranking);\n                const userShoes: any = this.getUserShoes(users[item].user_id);\n                console.log(userShoes);\n                let net: number = 0;\n                let sunk: number = 0;\n                let revenue: number = 0;\n                for (const shoe in userShoes) {\n                    if (userShoes.hasOwnProperty(shoe)) {\n                        net = net + userShoes[shoe].current_price - userShoes[shoe].purchase_price;\n                        sunk = sunk + userShoes[shoe].purchase_price;\n                        revenue = revenue + userShoes[shoe].current_price;\n                    }\n                }\n                let avgNet: number;\n                if (userShoes.length === 0) {\n                    avgNet = 0;\n                } else {\n                    avgNet = net / userShoes.length;\n                    ranking[\"net\"] = net;\n                    ranking[\"sunk\"] = sunk;\n                    ranking[\"revenue\"] = revenue;\n                    ranking[\"avg_net\"] = avgNet;\n                    ranking[\"num\"] = userShoes.length;\n                    leaderboard.push(ranking);\n                }\n            }\n        }\n        leaderboard.sort((a: any, b: any) => b.net - a.net);\n    }\n\n    private async setLocals() {\n        await this.setUsers();\n        await this.setShoes();\n    }\n\n    private async setUsers() {\n        const uif = new CustomerModel();\n        users = await uif.get_users();\n        allUserShoes = await uif.get_all_keys();\n    }\n\n    private async setShoes() {\n        const shoeIF = new ProductModel();\n        Shoes = await shoeIF.getAllDB();\n    }\n\n    private getShoe(shoeID: number) {\n        for (const item in Shoes) {\n            if (Shoes.hasOwnProperty(item)) {\n                const shoe = Shoes[item];\n                if (shoe.shoe_id === shoeID) {\n                    return shoe;\n                }\n            }\n        }\n    }\n\n    private getUserShoes(userID: any) {\n        const userShoes: any[] = [];\n        for (const item in allUserShoes) {\n            if (allUserShoes.hasOwnProperty(item)) {\n                if (allUserShoes[item].user_id === userID) {\n                    const shoe = allUserShoes[item];\n                    const shoeInfo = this.getShoe(allUserShoes[item].shoe_id);\n                    shoe[\"current_price\"] = shoeInfo.current_price;\n                    userShoes.push(shoe);\n                }\n            }\n        }\n        return userShoes;\n    }\n\n}\n"]}