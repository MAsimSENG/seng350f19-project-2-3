{"version":3,"file":"leaderboardController.js","sourceRoot":"","sources":["../../../src/controllers/leaderboardController.ts"],"names":[],"mappings":"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","sourcesContent":["import { NextFunction, Request, Response, Router} from \"express\";\r\nimport Helpers = require(\"../helperFunctions\");\r\nimport { BaseRoute } from \"../routes/router\";\r\n\r\nlet leaderboard: any[] = [];\r\nlet Shoes: any;\r\nlet users: any;\r\nlet allUserShoes: any;\r\nlet id: any;\r\n\r\nexport class LeaderboardController extends BaseRoute {\r\n\r\n    public static create(router: Router) {\r\n        router.get(\"/user/:id/leaderboard\", (req: Request, res: Response, next: NextFunction) => {\r\n            new LeaderboardController().leaderboard(req, res, next);\r\n        });\r\n\r\n        router.get(\"/user/:id/leaderboard/avgNetHigh\", (req: Request, res: Response, next: NextFunction) => {\r\n            new LeaderboardController().avgNetHigh(req, res, next);\r\n        });\r\n\r\n        router.get(\"/user/:id/leaderboard/avgNetLow\", (req: Request, res: Response, next: NextFunction) => {\r\n            new LeaderboardController().avgNetLow(req, res, next);\r\n        });\r\n\r\n        router.get(\"/user/:id/leaderboard/netHigh\", (req: Request, res: Response, next: NextFunction) => {\r\n            new LeaderboardController().netHigh(req, res, next);\r\n        });\r\n\r\n        router.get(\"/user/:id/leaderboard/netLow\", (req: Request, res: Response, next: NextFunction) => {\r\n            new LeaderboardController().netLow(req, res, next);\r\n        });\r\n\r\n    }\r\n\r\n    public async leaderboard(req: Request, res: Response, next: NextFunction) {\r\n        const idString = \"id\";\r\n        const userId = parseInt(req.params[idString], 10);\r\n        if (await this.createBoard(userId)) {\r\n            this.render(req, res, \"leaderboard\", {id: userId, title: \"Leaderboard\", leaderboard});\r\n        } else {\r\n            Helpers.ID404(res);\r\n        }\r\n    }\r\n\r\n    public async avgNetHigh(req: Request, res: Response, next: NextFunction) {\r\n        const idString = \"id\";\r\n        const userId = parseInt(req.params[idString], 10);\r\n        if (await this.check_local(userId)) {\r\n                leaderboard.sort((a: any, b: any) => b.avg_net - a.avg_net);\r\n                this.render(req, res, \"leaderboard\", {id: userId, title: \"Leaderboard\", leaderboard});\r\n        } else {\r\n            Helpers.ID404(res);\r\n        }\r\n    }\r\n\r\n    public async avgNetLow(req: Request, res: Response, next: NextFunction) {\r\n        const idString = \"id\";\r\n        const userId = parseInt(req.params[idString], 10);\r\n        if (await this.check_local(userId)) {\r\n            leaderboard.sort((a: any, b: any) => a.avg_net - b.avg_net);\r\n            this.render(req, res, \"leaderboard\", {id: userId, title: \"Leaderboard\", leaderboard});\r\n        } else {\r\n            Helpers.ID404(res);\r\n        }\r\n    }\r\n\r\n    public async netLow(req: Request, res: Response, next: NextFunction) {\r\n        const idString = \"id\";\r\n        const userId = parseInt(req.params[idString], 10);\r\n        if (await this.check_local(userId)) {\r\n            leaderboard.sort((a: any, b: any) => a.net - b.net);\r\n            this.render(req, res, \"leaderboard\", {id: userId, title: \"Leaderboard\", leaderboard});\r\n        } else {\r\n            Helpers.ID404(res);\r\n        }\r\n    }\r\n\r\n    public async netHigh(req: Request, res: Response, next: NextFunction) {\r\n        const idString = \"id\";\r\n        const userId = parseInt(req.params[idString], 10);\r\n        if (await this.check_local(userId)) {\r\n            leaderboard.sort((a: any, b: any) => b.net - a.net);\r\n            this.render(req, res, \"leaderboard\", {id: userId, title: \"Leaderboard\", leaderboard});\r\n        } else {\r\n            Helpers.ID404(res);\r\n        }\r\n    }\r\n\r\n    private async check_local(userID: any) {\r\n        if (leaderboard.length === 0) {\r\n            return await this.createBoard(userID);\r\n        } else if (userID !== id) {\r\n            return await this.createBoard(userID);\r\n        }\r\n        return true;\r\n    }\r\n\r\n    private async createBoard(userID: any) {\r\n        leaderboard = [];\r\n        if (await Helpers.isUser(userID)) {\r\n            id = userID;\r\n            await this.setLocals();\r\n            for (const item in users) {\r\n                if (users.hasOwnProperty(item)) {\r\n                    const ranking = users[item];\r\n                    const userShoes: any = this.getUserShoes(users[item].user_id);\r\n                    this.buildRanking(userShoes, ranking);\r\n                }\r\n            }\r\n            leaderboard.sort((a: any, b: any) => b.net - a.net);\r\n            return true;\r\n        } else {\r\n            return false;\r\n        }\r\n    }\r\n\r\n    private buildRanking(userShoes: any, ranking: any) {\r\n        let net: number;\r\n        let sunk: number;\r\n        let revenue: number;\r\n        [net, sunk, revenue] = Helpers.setNet(userShoes);\r\n        let avgNet: number;\r\n        if (userShoes.length === 0) {\r\n            avgNet = 0;\r\n        } else {\r\n            avgNet = net / userShoes.length;\r\n        }\r\n        ranking[\"net\"] = net;\r\n        ranking[\"sunk\"] = sunk;\r\n        ranking[\"revenue\"] = revenue;\r\n        ranking[\"avg_net\"] = avgNet;\r\n        ranking[\"num\"] = userShoes.length;\r\n        leaderboard.push(ranking);\r\n    }\r\n\r\n    private async setLocals() {\r\n        users = await Helpers.getUsers();\r\n        Shoes = await Helpers.getAllDbShoes();\r\n        allUserShoes = await Helpers.getAllUserShoes();\r\n    }\r\n\r\n    private getShoe(shoeID: number) {\r\n        for (const item in Shoes) {\r\n            if (Shoes.hasOwnProperty(item)) {\r\n                const shoe = Shoes[item];\r\n                if (shoe.shoe_id === shoeID) {\r\n                    return shoe;\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    private getUserShoes(userID: any) {\r\n        const userShoes: any[] = [];\r\n        for (const item in allUserShoes) {\r\n            if (allUserShoes.hasOwnProperty(item)) {\r\n                if (allUserShoes[item].user_id === userID) {\r\n                    const shoe = allUserShoes[item];\r\n                    const shoeInfo = this.getShoe(allUserShoes[item].shoe_id);\r\n                    shoe[\"current_price\"] = shoeInfo.current_price;\r\n                    userShoes.push(shoe);\r\n                }\r\n            }\r\n        }\r\n        return userShoes;\r\n    }\r\n\r\n}\r\n"]}