{"version":3,"file":"notificationController.js","sourceRoot":"","sources":["../../../src/controllers/notificationController.ts"],"names":[],"mappings":"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","sourcesContent":["import { NextFunction, Request, Response, Router} from \"express\";\nimport { ProductModel } from \"../models/productModel\";\nimport { NotificationModel } from \"../models/notificationModel\";\nimport { CustomerModel } from \"../models/customerModel\";\nimport { BaseRoute } from \"../routes/router\";\n\nlet userNotifications: any;\nlet Shoes: any;\n\nexport class NotificationController extends BaseRoute {\n\n    public static create(router: Router) {\n        router.get(\"/user/:id/notifications\", (req: Request, res: Response, next: NextFunction) => {\n            new NotificationController().notificationCentre(req, res, next);\n        });\n\n        router.get(\"/user/:id/add_notification/:id2\", (req: Request, res: Response, next: NextFunction) => {\n            new NotificationController().inputNotification(req, res, next);\n        });\n\n        router.get(\"/user/:id/edit_notification/:id2\", (req: Request, res: Response, next: NextFunction) => {\n            new NotificationController().editNotificationForm(req, res, next);\n        });\n\n        router.post(\"/user/:id/add_notification/:id2\", (req: Request, res: Response, next: NextFunction) => {\n            new NotificationController().addNotification(req, res, next);\n        });\n\n        router.post(\"/user/:id/remove_notification/:id2\", (req: Request, res: Response, next: NextFunction) => {\n            new NotificationController().removeNotification(req, res, next);\n        });\n\n        router.post(\"/user/:id/edit_notification/:id2\", (req: Request, res: Response, next: NextFunction) => {\n            new NotificationController().editNotification(req, res, next);\n        });\n\n\n    }\n\n    // constructor() {\n        // not much here yet\n    // }\n\n    public async notificationCentre(req: Request, res: Response, next: NextFunction) {\n        const idString = \"id\";\n        const userId = parseInt(req.params[idString], 10);\n        const shoe_if = new ProductModel();\n        const notif_if = new NotificationModel();\n        let notifArray: any[] = [];\n        if (await this.isUser(userId)) {\n            Shoes = await shoe_if.getAllDB();\n            await this.getUserNotifications(userId);\n            for (const item in userNotifications) {\n                if (userNotifications.hasOwnProperty(item)) {\n                    const notification = userNotifications[item];\n                    const shoe = this.getShoe(notification.shoe_id);\n                    notification[\"shoename\"] = shoe.brand + ' ' + shoe.model + ' ' + shoe.colorway;\n                    notification[\"current_price\"] = shoe.current_price;\n                    notification[\"size\"] = shoe.size;\n                    if (!notification.fulfilled) {\n                        if ((notification.type == \"Below\") && (notification.threshold > shoe.current_price)) {\n                            await notif_if.fulfill(notification._id);\n                            notification.fulfilled = true;\n                        }\n                        if ((notification.type == \"Above\") && (notification.threshold < shoe.current_price)) {\n                            console.log(notification._id);\n                            await notif_if.fulfill(notification._id);\n                            notification.fulfilled = true;\n                        }\n                    }\n                    notifArray.push(notification);\n                }\n            }\n            this.render(req, res, \"notificationCentre\", {id: userId, title: \"Notifications\", notifications:notifArray});\n        } else {\n            res.status(404)\n            .send({\n                message: \"No user with associated ID. Check the entered number.\",\n                status: res.status,\n            });        }\n    }\n\n    public async addNotification(req: Request, res: Response, next: NextFunction) {\n        const uString = \"id\";\n        const sString = \"id2\";\n        const userID = parseInt(req.params[uString]);\n        const shoeID = parseInt(req.params[sString]);\n        const nIF = new NotificationModel();\n        let threshold = req.body.threshold;\n        if (!threshold) {\n            threshold = 0;\n        }\n        await nIF.addNotification(userID, shoeID, threshold, req.body.type);\n        res.redirect('/user/' + userID + '/allShoes');\n    }\n\n    public async removeNotification(req: Request, res: Response, next: NextFunction) {\n        const uString = \"id\";\n        const idString = \"id2\";\n        const userID = parseInt(req.params[uString]);\n        const notifID = req.params[idString];\n        const nIF = new NotificationModel();\n        await nIF.remove_notif(notifID);\n        res.redirect('/user/' + userID + '/notifications');\n    }\n\n    public async editNotification(req: Request, res: Response, next: NextFunction) {\n        const uString = \"id\";\n        const idString = \"id2\";\n        const userID = parseInt(req.params[uString]);\n        const notifID = req.params[idString];\n        const nIF = new NotificationModel();\n        if (!req.body.threshold) {\n            req.body.threshold = 0;\n        }\n        await nIF.edit_notif(notifID, req.body.threshold, req.body.type);\n        res.redirect('/user/' + userID + '/notifications');\n    }\n\n    private async getUserNotifications(userID:number) {\n        const notif_if = new NotificationModel();\n        userNotifications = await notif_if.getUserNotifications(userID);\n\n        return userNotifications;\n    }\n\n    public async inputNotification(req: Request, res: Response, next: NextFunction) {\n        const userIdString = \"id\";\n        const userId = parseInt(req.params[userIdString], 10);\n        const shoeIdString = \"id2\";\n        const shoeId = parseInt(req.params[shoeIdString], 10);\n        const shoeIF = new ProductModel();\n        const shoe = await shoeIF.getOneShoe(shoeId);\n        if (shoe && await this.isUser(userId)) {\n            this.render(req, res, \"addNotification\", {id: userId, shoe});\n            /* res.status(200)\n                .send({\n                    message: 'Success',\n                    status: res.status,\n                    shoe\n                }); */\n        } else {\n            res.status(404)\n                .send({\n                    message: \"No shoe found with the given id.\",\n                    status: res.status,\n                });\n        }\n\n    }\n\n    public async editNotificationForm(req: Request, res: Response, next: NextFunction) {\n        const userIdString = \"id\";\n        const userId = parseInt(req.params[userIdString], 10);\n        const notIdString = \"id2\";\n        const notId = req.params[notIdString];\n        const notification = await this.getNotif(notId);\n        this.render(req, res, \"editNotification\", {id: userId, title: \"Notification\", notification:notification});\n    }\n\n    private getShoe(shoeID:number) {\n        for (const item in Shoes) {\n            if (Shoes.hasOwnProperty(item)) {\n                const shoe = Shoes[item];\n                if (shoe.shoe_id === shoeID) return shoe;\n            }\n        }\n    }\n\n    private async getNotif(id: any) {\n        const nIF = new NotificationModel();\n        const notif = await nIF.get_notif(id);\n        return notif[0];\n    }\n\n    private async isUser(userID: any) {\n        const userIF = new CustomerModel();\n        return await userIF.isUser(userID);\n    }\n}\n"]}