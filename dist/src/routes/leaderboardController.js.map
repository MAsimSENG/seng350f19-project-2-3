{"version":3,"file":"leaderboardController.js","sourceRoot":"","sources":["../../../src/routes/leaderboardController.ts"],"names":[],"mappings":"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","sourcesContent":["import { NextFunction, Request, Response, Router} from \"express\";\nimport { ShoeModel } from \"../models/shoe_model\";\nimport { NotificationModel } from \"../models/notification_model\";\nimport { UserModel } from \"../models/user_model\";\nimport { BaseRoute } from \"./router\";\n\nlet leaderboard: any[] = [];\nlet Shoes: any;\nlet users: any;\nlet allUserShoes: any;\nlet id:any;\n\nexport class LeaderboardController extends BaseRoute {\n\n    public static create(router: Router) {\n        router.get(\"/user/:id/leaderboard\", (req: Request, res: Response, next: NextFunction) => {\n            new LeaderboardController().leaderboard(req, res, next);\n        });\n\n        router.get(\"/user/:id/leaderboard/avgNetHigh\", (req: Request, res: Response, next: NextFunction) => {\n            new LeaderboardController().avgNetHigh(req, res, next);\n        });\n\n        router.get(\"/user/:id/leaderboard/avgNetLow\", (req: Request, res: Response, next: NextFunction) => {\n            new LeaderboardController().avgNetLow(req, res, next);\n        });\n\n        router.get(\"/user/:id/leaderboard/netHigh\", (req: Request, res: Response, next: NextFunction) => {\n            new LeaderboardController().netHigh(req, res, next);\n        });\n\n        router.get(\"/user/:id/leaderboard/netLow\", (req: Request, res: Response, next: NextFunction) => {\n            new LeaderboardController().netLow(req, res, next);\n        });\n\n    }\n\n\n    public async leaderboard(req: Request, res: Response, next: NextFunction) {\n        const idString = \"id\";\n        const userId = parseInt(req.params[idString], 10);\n        if (await this.createBoard(userId)) {\n            this.render(req, res, \"leaderboard\", {id: userId, title: \"Leaderboard\", leaderboard});\n        } else {\n            res.status(404)\n            .send({\n                message: \"No user with associated ID. Check the entered number.\",\n                status: res.status,\n            });        }\n    }\n\n    public async avgNetHigh(req: Request, res: Response, next: NextFunction) {\n        const idString = \"id\";\n        const userId = parseInt(req.params[idString], 10);\n        if (await this.check_local(userId)) {\n                leaderboard.sort((a: any, b: any) => b.avg_net - a.avg_net);\n                this.render(req, res, \"leaderboard\", {id: userId, title: \"Leaderboard\", leaderboard});\n        }\n        else {\n            res.status(404)\n                .send({\n                    message: \"No user with associated ID. Check the entered number.\",\n                    status: res.status,\n                });        }\n    }\n\n    public async avgNetLow(req: Request, res: Response, next: NextFunction) {\n        const idString = \"id\";\n        const userId = parseInt(req.params[idString], 10);\n        if (await this.check_local(userId)) {\n            leaderboard.sort((a: any, b: any) => a.avg_net - b.avg_net);\n            this.render(req, res, \"leaderboard\", {id: userId, title: \"Leaderboard\", leaderboard});\n        }\n        else {\n            res.status(404)\n                .send({\n                    message: \"No user with associated ID. Check the entered number.\",\n                    status: res.status,\n                });        }\n    }\n\n    public async netLow(req: Request, res: Response, next: NextFunction) {\n        const idString = \"id\";\n        const userId = parseInt(req.params[idString], 10);\n        if (await this.check_local(userId)) {\n            leaderboard.sort((a: any, b: any) => a.net - b.net);\n            this.render(req, res, \"leaderboard\", {id: userId, title: \"Leaderboard\", leaderboard});\n        }\n        else {\n            res.status(404)\n                .send({\n                    message: \"No user with associated ID. Check the entered number.\",\n                    status: res.status,\n                });        }\n    }\n\n    public async netHigh(req: Request, res: Response, next: NextFunction) {\n        const idString = \"id\";\n        const userId = parseInt(req.params[idString], 10);\n        if (await this.check_local(userId)) {\n            leaderboard.sort((a: any, b: any) => b.net - a.net);\n            this.render(req, res, \"leaderboard\", {id: userId, title: \"Leaderboard\", leaderboard});\n        }\n        else {\n            res.status(404)\n                .send({\n                    message: \"No user with associated ID. Check the entered number.\",\n                    status: res.status,\n                });        }\n    }\n\n    private async check_local(userID: any) {\n        if (leaderboard.length == 0) {\n            return await this.createBoard(userID);\n        }\n        else if (userID != id) {\n            return await this.createBoard(userID);\n        }\n        return true;\n    }\n\n    private async createBoard(userID: any) {\n        leaderboard = [];\n        if (await this.isUser(userID)) {\n            id = userID;\n            await this.setLocals();\n            for (const item in users) {\n                if (users.hasOwnProperty(item)) {\n                    const ranking = users[item];\n                    //console.log(ranking);\n                    const userShoes: any = this.getUserShoes(users[item].user_id);\n                    console.log(userShoes);\n                    let net: number = 0;\n                    let sunk: number = 0;\n                    let revenue: number = 0;\n                    for (const shoe in userShoes) {\n                        if (userShoes.hasOwnProperty(shoe)) {\n                            net = net + userShoes[shoe].current_price - userShoes[shoe].purchase_price;\n                            sunk = sunk + userShoes[shoe].purchase_price;\n                            revenue = revenue + userShoes[shoe].current_price;\n                        }\n                    }\n                    let avg_net: number;\n                    if (userShoes.length === 0) {\n                        avg_net = 0;\n                    }\n                    else avg_net = net/userShoes.length;\n                    ranking[\"net\"] = net;\n                    ranking[\"sunk\"] = sunk;\n                    ranking[\"revenue\"] = revenue;\n                    ranking[\"avg_net\"] = avg_net;\n                    ranking[\"num\"] = userShoes.length;\n                    leaderboard.push(ranking);\n                }\n            }\n            leaderboard.sort((a: any, b: any) => b.net - a.net);\n            return true;\n        }\n        else return false;\n    }\n\n    private async setLocals() {\n        await this.setUsers();\n        await this.setShoes();\n    }\n\n    private async setUsers() {\n        const uif = new UserModel();\n        users = await uif.get_users();\n        allUserShoes = await uif.get_all_keys();\n    }\n\n    private async setShoes() {\n        const shoeIF = new ShoeModel();\n        Shoes = await shoeIF.getAllDB();\n    }\n\n    private getShoe(shoeID:number) {\n        for (const item in Shoes) {\n            if (Shoes.hasOwnProperty(item)) {\n                const shoe = Shoes[item];\n                if (shoe.shoe_id === shoeID) return shoe;\n            }\n        }\n    }\n\n    private getUserShoes(userID: any) {\n        let userShoes: any[] = [];\n        for (const item in allUserShoes) {\n            if (allUserShoes.hasOwnProperty(item)) {\n                if (allUserShoes[item].user_id === userID) {\n                    const shoe = allUserShoes[item];\n                    const shoe_info = this.getShoe(allUserShoes[item].shoe_id);\n                    shoe[\"current_price\"] = shoe_info.current_price;\n                    userShoes.push(shoe);\n                }\n            }\n        }\n        return userShoes;\n    }\n\n    private async isUser(userID: any) {\n        const userIF = new UserModel();\n        return await userIF.isUser(userID);\n    }\n}\n"]}