{"version":3,"file":"cron.js","sourceRoot":"","sources":["../../src/cron.ts"],"names":[],"mappings":"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","sourcesContent":["import \"mocha\";\nimport DbClient = require(\"./DbClient\");\nimport { ProductModel } from \"./models/productModel\";\nimport { exists } from \"fs\";\n\nlet chai = require(\"chai\");\n\nconst cron = require(\"node-cron\");\nconst fs = require(\"fs\");\n\nconst datab = DbClient.connect()\nconst date = new Date();\nvar updateSuccess = false;\nvar integrity_new;\nvar integrity_old = datab.then(db => {\n    return db!.collection(\"shoes\").find().toArray();\n})\n.catch((err) => {\n    console.log(\"Failed to grab shoe array\");\n    return false;\n});\n\n/*************\n * CRON JOBS *\n *************/\n\n/**\n * The purpose of this cron job is to update the database every minute (in an attempt to mock data)\n * If the mock is successful, the job appends a success log to the end of a local log file\n */\nconst shoeUpdate = new ProductModel();\ncron.schedule(\"* * * * *\", (err: any) => {\n    if (err) {\n        throw err;\n    }\n    const update = datab.then(db => {\n        db!.collection(\"shoes\").updateMany({}, { $inc: { current_price: 2 } });\n        return true;\n    })\n    .catch((err) => {\n        console.log(\"Failed to update shoes\");\n        return false;\n    });\n\n    if (update) {\n        fs.appendFile(\"./logs/update.log\",\n            date.toLocaleString() + \" --- Updated all shoes by $2 successfully\\n\", (err: any) => {\n                if (err) {\n                    throw err;\n                }\n        });\n        updateSuccess = true;\n    } else {\n        fs.appendFile(\"./logs/update.log\",\n            date.toLocaleString() + \" --- FATAL ERROR: FAILED TO UPDATE SHOES ***********\\n\", (err: any) => {\n                if (err) {\n                    throw err;\n                }\n        });\n        updateSuccess = false\n    }\n});\n\n/**\n * The purpose of this log file is to automatically test our integrity quality attribute (issue #14)\n * The cron job will open it's own connection to the database and grab the list of shoes. It will then \n * compare this list of shoes to the previous hours list to verify a change has been made. From there it\n * will use one of the apps routes that will run a similar query, and compare the results. If there are any\n * discrepencies the cron job will send the developers an e-mail. This is done at the beginning of every hour.\n */\ncron.schedule(\"* * * * *\", (err: any) => {\n    if (err) {\n        throw err;\n    }\n    // If the last update was successful continue, otherwise no need\n    if(updateSuccess) {\n        var integrity_new = datab.then(db => {\n            return db!.collection(\"shoes\").find().toArray();\n        })\n        .catch((err) => {\n            console.log(\"Failed to grab shoe array\");\n            return false;\n        });\n    } else {\n        fs.appendFile(\"./logs/integrity.log\",\n            date.toLocaleString() + \" --- FATAL ERROR: LAST UPDATE FAILED\\n\", (err: any) => {\n                if (err) {\n                    throw err;\n                }\n            });\n        return;\n    }\n    \n    // Verify that the update occured\n    chai.expect(integrity_new).to.not.equal(integrity_old)\n        // .catch((e: any) => {\n        //     fs.appendFile(\"./logs/integrity.log\",\n        //         date.toLocaleString() + \" --- FATAL ERROR: OLD DATA == NEW DATA. SOMETHING WEIRD HAPPENED\\n\", (err: any) => {\n        //             if (err) {\n        //                 throw err;\n        //             }\n        //         });\n        //     throw e\n        // });\n\n    const shoes = new ProductModel();\n    const allShoes = shoes.getAllDB();\n\n    console.log(integrity_new)\n    console.log(\"***************\")\n    console.log(allShoes);\n    // Verify that the shoe list is the same\n    chai.expect(allShoes).to.equal(integrity_new)\n        // .catch((e: any) => {\n        //     fs.appendFile(\"./logs/integrity.log\",\n        //         date.toLocaleString() + \" --- FATAL ERROR: NEW DATA NOT REFLECTED ON APP\\n\", (err: any) => {\n        //             if (err) {\n        //                 throw err;\n        //             }\n        //         });\n        //     throw e\n        // });\n\n    fs.appendFile(\"./logs/integrity.log\",\n        date.toLocaleString() + \" --- Data integrity test passed.\\n\", (err: any) => {\n            if (err) {\n                throw err;\n            }\n        });\n\n    \n    // Update integrity_old\n    integrity_old = integrity_new;\n});\n\n/**\n * The pusepose of this cron jobs is to renew the log files at the end of every Sunday\n * This is done with the goal of not having a 20gb log file that ends up crashing the server\n */\ncron.schedule(\"59 23 * * 0\", () => {\n    fs.unlink(\"./logs/update.log\", (err: any) => {\n        if (err) {\n            throw err;\n        }\n    });\n    fs.link(\"./logs/update.log\", (err: any) => {\n        if (err) {\n            throw err;\n        }\n        console.log(\"Integrity file successfully re-created!\");\n    });\n    fs.unlink(\"./logs/integrity.log\", (err: any) => {\n        if (err) {\n            throw err;\n        }\n    });\n    fs.link(\"./logs/integrity.log\", (err: any) => {\n        if (err) {\n            throw err;\n        }\n        console.log(\"Integrity file successfully re-created!\");\n    });\n\n});\n"]}